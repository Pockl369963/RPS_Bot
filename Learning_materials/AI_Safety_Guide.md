# AI安全策ガイド (3.5 Safety Mechanisms)

AIの意思決定プロセスの最後を担うのが、「安全策 (Safety Mechanisms)」です。
これは、予測器やメタ戦略が機能不全に陥ったり、特定の脆弱性を突かれたりした際の「緊急停止スイッチ」や「オーバーライド」として機能します。

---

## 1. 役割

`Selector` が決定した手に対して、「待った」をかけます。
履歴データをチェックし、もし特定の問題パターン（連打や負けすぎ）が見つかれば、Selectorの決定を無視して強制的に安全な手を選択します。

---

## 2. 実装された機能

### 2.1 Anti-Spam (連打対策)
ユーザーが同じ手を連続して出してくる（スパム行為）場合、通常の予測器は「パターン」として認識しますが、Safetyはより直接的に「カモ」として扱います。

*   **トリガー**: 直近10手のうち、同一の手が8回以上 (80%以上) 出現。
*   **アクション**: その「連打されている手」の天敵（勝つ手）を強制的に出す。
*   **効果**: 「グー」を連打する相手には、ひたすら「パー」を出し続ける（予測器が迷うのを防ぐ）。

### 2.2 Stop-Loss (損切り)
AIがドツボにはまり、負け続けている場合、現在の戦略が相手に読まれている可能性が高いです。
この場合、一度リセットしてランダムな動きに戻すことで、相手の裏の裏をかく推論から抜け出します。

*   **トリガー**: 直近20戦のAI勝率が25%未満（5勝未満）。
*   **アクション**: 完全ランダム (`random.choice`) に切り替える。
*   **効果**: 負のスパイラルを断ち切り、勝率を33%（理論値）まで一旦戻す。

---

## 3. 実装コード例

```python
# Check Anti-Spam
moves = [h.get("user_move") for h in recent_10]
most_common, freq = Counter(moves).most_common(1)[0]
if freq >= 8:
    return get_winning_move(most_common), "Safety_AntiSpam"
```

---

## まとめ：AIエンジンの完成

これで、Evolutionary RPSの「頭脳」が完成しました。

1.  **Predictors**: 様々な角度から次の一手を予測
2.  **Strategy Selector**: 最適な予測器と戦術を選択
3.  **Safety Mechanisms**: 異常事態を検知してオーバーライド

この3段構えのアーキテクチャにより、初心者から心理戦の達人まで、あらゆるプレイヤーに適応して進化するAIとなります。
