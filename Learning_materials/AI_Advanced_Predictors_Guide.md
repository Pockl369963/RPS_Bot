# AI予測器実装ガイド：応用編 (3.3 Pattern Matcher)

基本予測器に続き、より強力な「パターンマッチング予測器」を実装します。

---

## 1. 概念: 過去は繰り返される

人間は無意識に特定のリズムやパターンで手を出す傾向があります（例: 「グー・チョキ・パー」のサイクルや、「勝ちパターンを繰り返す」など）。
**Pattern Matcher** は、現在の直近の動き（サフィックス）と一致するシーケンスを過去の全履歴から検索し、その「続き」を予測します。

---

## 2. アルゴリズム詳細

### コンセプト
履歴が `... R P S R P` だとします。
直近の動きは `R P` です。
過去に `R P` という並びがあったか探し、もし `... R P "S" ...` と続いていたなら、今回も `S` が来ると予測します。

### 実装ステップ (Longest Suffix Match)

1.   **文字列化**: 履歴データのユーザーの手を文字列に変換します (例: `"RPSRPS..."`)。
2.  **サフィックス探索**: 直近 k 個の手（パターン）を取り出します。k は最大長（例: 10）から最小長（2）まで減らしながらループします。
3.  **過去の検索**: 取り出したパターンが、履歴の「それ以前」の部分に出現しているか検索します。
    *   検索範囲は `history[:-1]` (今回の直前を含まない過去) です。
    *   `rfind` を使い、最も新しい過去の事例を探すと効果的です。
4.  **予測**: 見つかったパターンの「次の1手」を予測値とします。

```python
search_text = moves[:-1] 
idx = search_text.rfind(pattern)
if idx != -1:
    return search_text[idx + len(pattern)]
```

---

## 3. テスト

「R -> P -> S」のリズムを繰り返すユーザーに対して、正しく次の手を予測できるかテストしました。

```python
history = [
    # 1回目
    {"user_move": "R"}, {"user_move": "P"}, {"user_move": "S"},
    # 2回目
    {"user_move": "R"}, {"user_move": "P"}, {"user_move": "S"},
    # 3回目: R -> P まで来た
    {"user_move": "R"}, {"user_move": "P"},
]
# ここで S を予測できれば成功
```

---

これで、4種類の予測器 (Random, Markov, Frequency, PatternMatch) が揃いました。
次はこれらを統括し、最適な戦略を選ぶ「メタ戦略 (Selector)」の実装に進みます。
