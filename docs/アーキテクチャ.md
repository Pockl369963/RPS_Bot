# アーキテクチャ設計書

## 1. システムコンテキスト (System Context)

本システム「Evolutionary RPS」は、ユーザー（ブラウザ）とサーバー（Django）が対話するWebアプリケーションである。

```mermaid
graph LR
    User((User)) -->|HTTPS| Browser[Web Browser]
    Browser -->|JSON/API| Server[Django Server]
    Server -->|Read/Write| DB[(SQLite Database)]
    
    subgraph "Evolutionary RPS System"
        Browser
        Server
        DB
    end
```

## 2. コンテナ図 (Container Diagram)

サーバーサイドの内部構成と、AIエンジンの配置を示す。

```mermaid
graph TB
    subgraph "Client Side"
        UI[Frontend UI\n(HTML/JS/Tailwind)]
    end

    subgraph "Server Side (Django)"
        API[API Views\n(views.py)]
        GameLogic[Game Logic]
        
        subgraph "AI Engine"
            Selector[Strategy Selector]
            Predictors[Predictors\n(Markov, Pattern, etc.)]
            Safety[Safety Mechanisms]
        end
        
        Models[ORM Models]
    end
    
    DB[(SQLite)]

    UI -->|POST /api/play| API
    UI -->|POST /api/reset| API
    
    API --> GameLogic
    GameLogic --> Selector
    Selector --> Safety
    Safety --> Predictors
    
    GameLogic --> Models
    Models --> DB
```

## 3. シーケンス図: 対戦フロー (Game Flow)

ユーザーが手を出し、AIが予測して結果を返すまでの流れ。

```mermaid
sequenceDiagram
    participant User
    participant Client as Client (JS)
    participant API as Django API
    participant AI as AI Engine
    participant DB as Database

    User->>Client: Select Move (R/P/S)
    Client->>API: POST /api/play {move: "R"}
    
    activate API
    API->>DB: Fetch User History
    DB-->>API: History Data
    
    API->>AI: Predict Next User Move
    activate AI
    AI->>AI: Run Predictors (Markov, etc.)
    AI->>AI: Apply Meta-Strategy (P0/P1)
    AI->>AI: Check Safety Override
    AI-->>API: AI Move (e.g., "P")
    deactivate AI
    
    API->>API: Determine Winner
    API->>DB: Save Game Log
    API-->>Client: JSON {result: "lose", ai_move: "P", ...}
    deactivate API
    
    Client->>User: Show Result & Animation
```

## 4. ディレクトリ構造と責務

```mermaid
classDiagram
    class GameApp {
        views.py
        models.py
        urls.py
    }
    
    class AI_Package {
        predictors.py
        strategy.py
        utils.py
    }
    
    class Frontend {
        index.html
        game.js
        style.css
    }
    
    GameApp --> AI_Package : Uses
    GameApp --> Frontend : Serves
```

## 5. 技術スタックサマリ

| Layer | Technology | Version |
| :--- | :--- | :--- |
| **Frontend** | HTML5, Vanilla JS, Tailwind CSS | Latest |
| **Backend** | Python, Django | **5.2 LTS** |
| **Database** | SQLite | 3.x |
| **AI Logic** | Python (NumPy optional) | - |
| **Infra** | PythonAnywhere | - |
