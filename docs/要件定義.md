
-----

# 要件定義書：最強のじゃんけんBot "Evolutionary RPS" (Ver 2.0)

## 1\. プロジェクト概要

### 1.1 目的

  * 人間の行動パターン（癖）を学習・予測する高度なアンサンブルアルゴリズムを搭載し、対人勝率で統計的優位（勝率60%以上）を目指す。
  * **極端な戦法（一点読みやランダム連打）に対しても、統計的な負け越しを防ぐ安全策を実装する。**

### 1.2 コアコンセプト

**「進化する恐怖 (Evolutionary Terror)」**
AIが学習深度を深めるにつれて画面の雰囲気が「無機質な白（無害）」から「絶望的な黒（支配）」へと段階的に変化し、ユーザーに心理的プレッシャーを与える。

-----

## 2\. 技術スタック

### 2.1 開発環境

  * **言語:** Python 3.10以上
  * **仮想環境:** uvを使用
  * **フレームワーク:** Django (最新安定版)
  * **フロントエンド:** HTML5, JavaScript (Fetch API), Tailwind CSS (CDN版)

### 2.2 インフラ・データ永続化

  * **デプロイ先:** PythonAnywhere (推奨・無料枠)
  * **データベース:** SQLite (ファイルベース永続化)

-----

## 3\. アルゴリズム要件 (Ensemble + Safety)

複数の予測器による「攻め」と、異常検知による「守り」を組み合わせたハイブリッド戦略を採用する。

### 3.1 攻め：予測器群 (Predictors)

以下のロジックを並列動作させ、ユーザーの次の一手を予測する。

1.  **Random:** データ不足時用。
2.  **Markov Chain (1st & 2nd):** 直近の手の流れ（遷移確率）から予測。
3.  **Pattern Matcher:** 過去の全履歴から類似パターン（3〜5手）を検索。
4.  **Compression (LZW):** 圧縮アルゴリズムにより、データの規則性を抽出して予測。
5.  **Psychology (WSLS):** 「勝ったら変えない」「負けたら変える」心理を予測。
6.  **Frequency Analysis (Bias):** 直近10手で「極端に多い手」がないか統計的に予測。

### 3.2 統括：メタ戦略 (Iocaine Logic)

各予測器に対し、読みの深さを3段階展開する。

  * **P0 (Naive):** 予測通りに来ると仮定。
  * **P1 (Second-guess):** 「AIの予測を読んで裏をかいてくる」と仮定。

### 3.3 守り：安全策 (Safety Mechanisms) ← NEW

アンサンブル予測の結果を\*\*上書き(Override)\*\*する緊急回避ロジックを実装する。

  * **安全策A: Anti-Spam Override (連打対策)**
      * **条件:** 直近10手のうち、ユーザーが同じ手を**80%以上**出している場合。
      * **動作:** 複雑な深読みを停止し、その「偏った手」に対する必勝手を強制的に採用する。
      * *理由:* 「裏の裏」を読みすぎて、単純なグー連打に負ける事態を防ぐため。
  * **安全策B: Stop-Loss Random (ナッシュ均衡への退避)**
      * **条件:** 直近20手のAI勝率が**25%以下**に低下した場合（AIが完敗している緊急事態）。
      * **動作:** 全予測ロジックを一時停止し、\*\*完全ランダム（1/3）\*\*に切り替える。
      * *理由:* 相手にアルゴリズムを完全に解析されている可能性があるため、一度パターンを消してリズムをリセットする。

### 3.4 意思決定プロセス (Selector)

1.  **Safety Check:** 安全策AまたはBの条件に合致するか確認。合致すれば即決。
2.  **Scoring:** 合致しない場合、各予測器(P0/P1)の過去の成績（仮想勝率）を計算。
3.  **Decision:** 最もスコアが高い戦略を採用する。

-----

## 4\. UI/UX・演出要件

### 4.1 ダイナミック・テーマ (5 Phases)

AIの「対戦回数」と「支配率（勝率）」に基づき、配色を5段階で遷移させる。

| フェーズ | テーマ名 | 条件 (AND条件) | 配色 (Tailwind) | 演出意図 |
| :--- | :--- | :--- | :--- | :--- |
| **Phase 1** | **Observation** | 初期状態 | **白 / グレー** | **無害**<br>AIはまだデータを収集中。 |
| **Phase 2** | **Analysis** | 5戦以上 & 勝率40%↑ | **薄グレー** | **違和感**<br>分析開始の気配。 |
| **Phase 3** | **Conflict** | 10戦以上 & 勝率50%↑ | **濃グレー / 白** | **拮抗**<br>画面が暗転し始める。 |
| **Phase 4** | **Pressure** | 20戦以上 & 勝率55%↑ | **紺色 / 淡色** | **威圧**<br>重苦しいダークモード。 |
| **Phase 5** | **Domination** | 30戦以上 & 勝率60%↑ | **黒 / 赤** | **絶望**<br>AIによる完全支配。 |

※ \*\*安全策B（完全ランダム）\*\*発動時は、演出として画面にノイズを走らせるか、一時的に色が明滅する等のエフェクト（Glitch Effect）を加える（任意実装）。

-----

## 5\. データモデル設計

### 5.1 Player (User)

  * **ID:** UUID (Cookie永続化)。
  * **Stats:** ゲーム数、勝利数、敗北数。

### 5.2 GameLog

  * **Data:** ラウンド数、ユーザーの手、AIの手、勝敗。
  * **Strategy:** 採用された戦略名（例: `Markov_P1`, `Safety_AntiSpam`, `Safety_Random` 等を記録）。

### 5.3 リセット

  * ユーザーによる記憶消去（Phase 1リセット）機能。

-----

